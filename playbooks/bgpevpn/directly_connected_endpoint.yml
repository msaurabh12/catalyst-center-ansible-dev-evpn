---
- name: Configure Border Handoff on Cisco Devices
  hosts: localhost
  gather_facts: no
  connection: network_cli

  vars_files:
    - ../credentials.yml
    - ./vars/directly_connected_endpoint.yml

  tasks:
    - name: Validate BGP ASN
      ansible.builtin.assert:
        that:
          - bgp.asn is defined
          - bgp.asn | int > 0
          - bgp.asn | int < 65536

    - name: Validate border interfaces
      ansible.builtin.assert:
        that:
          - border_interfaces | length > 0
          - border_interfaces | selectattr('name', 'defined') | list | length == border_interfaces | length
          - border_interfaces | selectattr('vlan_id', 'defined') | list | length == border_interfaces | length
          - border_interfaces | selectattr('vrf', 'defined') | list | length == border_interfaces | length

    - name: Validate IPv4 fields
      ansible.builtin.assert:
        that:
          - item.ipv4.address is match("^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$")
          - item.ipv4.mask is match("^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$")
      loop: "{{ border_interfaces }}"

    - name: Validate IPv6 fields
      ansible.builtin.assert:
        that:
          - item.ipv6.address is match("^[0-9a-fA-F:]+$")
          - item.ipv6.prefix | int >= 1
          - item.ipv6.prefix | int <= 128
      loop: "{{ border_interfaces }}"

    - name: Validate BGP address families
      ansible.builtin.assert:
        that:
          - bgp.address_families | length > 0
          - bgp.address_families | selectattr('vrf', 'defined') | list | length == bgp.address_families | length
          - bgp.address_families | selectattr('type', 'defined') | list | length == bgp.address_families | length
    - name: Deploy Directly Connected Endpoints
      vars:
        mac_address: "{{ item.mac_address }}"
        rendered_directly_connected_endpoints: "{{ lookup('template', './jinja_templates/directly_connected_endpoint.j2') }}"
      cisco.dnac.template_workflow_manager:
        dnac_host: "{{ dnac_host }}"
        dnac_port: "{{ dnac_port }}"
        dnac_username: "{{ dnac_username }}"
        dnac_password: "{{ dnac_password }}"
        dnac_verify: "{{ dnac_verify }}"
        dnac_version: "{{ dnac_version }}"
        dnac_debug: "{{ dnac_debug }}"
        dnac_log_level: DEBUG
        dnac_log: true
        config_verify: true
        state: merged
        config:
          - configuration_templates:
              project_name: "evpn_directly_connected_endpoints"
              template_name: "evpn_evpn_directly_connected_endpoints_template_{{ item.ip }}"
              template_content: "{{ rendered_directly_connected_endpoints }}"
              version_description: "Auto-generated Directly connected endpoints config for {{ item.ip }}"
              language: JINJA
              software_type: "IOS-XE"
              device_types:
                - product_family: "Switches and Hubs"
          - deploy_template:
              project_name: "evpn_directly_connected_endpoints"
              template_name: "evpn_directly_connected_endpoint_{{ item.ip }}"
              force_push: true
              template_parameters:
                - param_name: "vlan_id"
                  param_value: "1431"
                - param_name: "vlan_name"
                  param_value: "testvlan31"
              device_details:
                device_ips:
                  - "{{ item.ip }}"
      loop: "{{ devices | default([{'ip': device_ip, 'mac_address': mac_address}]) }}"
      loop_control:
        label: "{{ item.ip }}"    
