---
- name: Configure BGP Aggregate Address on Border Prefix Limit
  hosts: localhost
  gather_facts: no
  connection: network_cli
  vars_files:
    - ../credentials.yml
    - ./vars/border_prefix_limit_vars.yml

  tasks:
    - name: Validate BGP ASN input
      ansible.builtin.assert:
        that:
          - bgp.asn is defined
          - bgp.asn | int > 0
          - bgp.asn | int < 65536
        fail_msg: "Invalid or missing BGP ASN"
        success_msg: "BGP ASN is valid"

    - name: Validate IPv4 address fields
      ansible.builtin.assert:
        that:
          - item.ipv4.address is match("^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$")
          - item.ipv4.mask is match("^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$")
        fail_msg: "Invalid IPv4 address or mask on {{ item.name }}"
        success_msg: "IPv4 config for {{ item.name }} is valid"
      loop: "{{ border_interfaces }}"

    - name: Validate IPv6 address fields
      ansible.builtin.assert:
        that:
          - item.ipv6.address is match("^[0-9a-fA-F:]+$")
          - item.ipv6.prefix | int >= 1
          - item.ipv6.prefix | int <= 128
        fail_msg: "Invalid IPv6 configuration on {{ item.name }}"
        success_msg: "IPv6 config for {{ item.name }} is valid"
      loop: "{{ border_interfaces }}"

    - name: Deploy Border Prefix Limit
      vars:
        mac_address: "{{ item.mac_address }}"
        rendered_evpn_border_prefix: "{{ lookup('template', './jinja_templates/border_prefix_limit.j2') }}"
      cisco.dnac.template_workflow_manager:
        dnac_host: "{{ dnac_host }}"
        dnac_port: "{{ dnac_port }}"
        dnac_username: "{{ dnac_username }}"
        dnac_password: "{{ dnac_password }}"
        dnac_verify: "{{ dnac_verify }}"
        dnac_version: "{{ dnac_version }}"
        dnac_debug: "{{ dnac_debug }}"
        dnac_log_level: DEBUG
        dnac_log: true
        config_verify: true
        state: merged
        config:
          - configuration_templates:
              project_name: "evpn_border_prefix_limit"
              template_name: "evpn_evpn_border_prefix_limit_template{{ item.ip }}"
              template_content: "{{ rendered_evpn_border_prefix }}"
              version_description: "Auto-generated Border Aggregate config for {{ item.ip }}"
              language: JINJA
              software_type: "IOS-XE"
              device_types:
                - product_family: "Switches and Hubs"
          - deploy_template:
              project_name: "evpn_border_prefix_limit"
              template_name: "evpn_evpn_border_prefix_limit_template{{ item.ip }}"
              force_push: true
              template_parameters:
                - param_name: "vlan_id"
                  param_value: "1431"
                - param_name: "vlan_name"
                  param_value: "testvlan31"
              device_details:
                device_ips:
                  - "{{ item.ip }}"
      loop: "{{ devices | default([{'ip': device_ip, 'mac_address': mac_address}]) }}"
      loop_control:
        label: "{{ item.ip }}"
        
